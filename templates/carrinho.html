{% extends 'base.html' %}
{% block title %}Carrinho{% endblock %}
{# removido load de currency: usando floatformat padrão #}
{% block content %}
<div class="card">
  <h2>Carrinho</h2>
  {% if itens %}
    <ul>
      {% for item in itens %}
        <li style="margin:6px 0;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span><strong>{{ item.produto.nome }}</strong></span>
          <span>Estoque: {{ item.produto.estoque }}</span>
          <form method="post" action="{% url 'carrinho_atualizar' item.produto.id %}" style="display:inline-flex;align-items:center;gap:6px;">
            {% csrf_token %}
            <label for="q{{ item.produto.id }}">Qtd:</label>
            <input id="q{{ item.produto.id }}" type="number" name="quantidade" min="1" value="{{ item.quantidade }}" style="width:80px;padding:4px;" />
            <button class="btn" type="submit">Atualizar</button>
          </form>
          <span>Subtotal: R$ {{ item.subtotal|floatformat:2 }}</span>
          <form method="post" action="{% url 'carrinho_remover' item.produto.id %}" style="display:inline-block;margin-left:8px;">
            {% csrf_token %}
            <button class="btn" type="submit">Remover</button>
          </form>
        </li>
      {% endfor %}
    </ul>
    <p><strong>Total: R$ {{ total|floatformat:2 }}</strong></p>
    <div style="margin-top: 12px;display:flex;gap:8px;flex-wrap:wrap;">
      {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'carrinho_finalizar' %}">
          {% csrf_token %}
          <button class="btn" type="submit">Finalizar Compra</button>
        </form>
      {% else %}
        <div style="padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 12px;">
          <p style="margin: 0 0 8px 0; color: #495057;">
            <strong>Para finalizar sua compra, você precisa estar logado.</strong>
          </p>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <a class="btn" href="{% url 'login' %}?next={% url 'carrinho' %}" style="background: #007bff;">Fazer Login</a>
            <a class="btn" href="{% url 'cadastro' %}" style="background: #28a745;">Criar Conta</a>
          </div>
        </div>
      {% endif %}
      <form method="post" action="{% url 'carrinho_limpar' %}">
        {% csrf_token %}
        <button class="btn" type="submit">Limpar Carrinho</button>
      </form>
      <a class="btn" href="{% url 'home' %}">Continuar Comprando</a>
    </div>
  {% else %}
    <p>Seu carrinho está vazio por enquanto.</p>
    <div style="margin-top: 12px;">
      <a class="btn" href="{% url 'home' %}">Ir às compras</a>
    </div>
  {% endif %}
</div>
{% endblock %}